<!-- <!DOCTYPE html> -->
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Resident Web Use Results</title>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <link rel="stylesheet" href="main.css" />
    <script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="//code.jquery.com/jquery-1.11.2.min.js" charset="utf-8"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script src="turf.min.js"></script>
	<script src="regression.js"></script>
	<script src="tabletop.js"></script>
	<script src="map.js"></script>
	<script src="lib.js"></script>
	<script src="census-reporter.js"></script>
	<script>
	
        var stuff = {
            spreadsheet_url: null,
            responses: null, tracts: null,
            city: {name: null, geoid: null},
            maps: {
                recommendation: {data: null, map: null},
                survey: {data: null, map: null}
                }
            };
	
        function try_placename()
        {
            update_status('Loading city tracts…');
            load_city_tracts(get_query_variable('cityname'), loaded_tracts);
        }

	    function loaded_tracts(city_geoid, city_name, tracts)
	    {
	        stuff.city.geoid = city_geoid;
	        stuff.city.name = city_name;
	    
            var geojson = {features: [], type: 'GeometryCollection'};
            
            for(var i = 0; i < tracts.length; i++)
            {
                geojson.features.push(tracts[i].feature);
            }
            
            stuff.maps.survey = ResidentResearch.map();
            stuff.maps.survey.init('survey-map', geojson);
            stuff.maps.recommendation = ResidentResearch.map();
            stuff.maps.recommendation.init('recommendation-map', geojson);

            create_overlay('survey-map', 'loading', '<h1>Loading city tracts...</h1>');
            create_overlay('recommendation-map', 'loading', '<h1>Loading city tracts...</h1>');
            
            jQuery('body').on("surveyMessage", surveyProgressEventHandler);
            jQuery('body').on("recommendationMessage", recommendationProgressEventHandler);
            message = 'Found ' + tracts.length + ' tracts. Loading data…';
            update_status(message);
            jQuery( "body" ).trigger( "surveyMessage", [message] );
            jQuery( "body" ).trigger( "recommendationMessage", [message] );
            load_tract_data(tracts, loaded_tract_data);
	    }
	    
	    function loaded_tract_data(tracts)
	    {
	        stuff.tracts = tracts;
	        
	        var buttons = new DemographicsControl(stuff.maps.recommendation, tracts);
	        stuff.maps.recommendation.addControl(buttons);
	    
            function onerror(reason, ttop)
            {
                alert('Failed to load spreadsheet: ' + reason);
            }

            var message = ('Loaded data for ' + tracts.length + ' tracts in ' + stuff.city.name + '. Loading spreadsheet…');
            update_status(message);
            jQuery( "body" ).trigger( "surveyMessage", [message] );
            remove_overlay('recommendation-map', 'loading');
            load_spreadsheet(get_query_variable('gdoc'), 'Survey Results All', loaded_spreadsheet, onerror);
	    }

        function loaded_spreadsheet(all_responses, spreadsheet_url)
        {
            stuff.responses = all_responses;
            stuff.spreadsheet_url = spreadsheet_url;
            
            var geo_responses = [],
                languages = {
                "english": 0,
                "spanish": 0,
                "chinese": 0,
                "vietnamese": 0
                },
                access = {
                "computer-at-home": 0,
                "cell-phone": 0,
                "computer-at-work": 0,
                "public-computer": 0,
                "friend-computer": 0
                };
            
            for(var i = 0; i < all_responses.length; i++)
            {
                jQuery( "body" ).trigger( "surveyMessage", ['Reading reponse '+(i+1)+' of '+all_responses.length+'...'] );
                var response = all_responses[i],
                    language = response.fields['Language spoken at home'];
                
                if(language && language.toLocaleLowerCase() in languages) {
                    languages[language.toLocaleLowerCase()] += 1;
                }
                
                if(response.fields['Web on computer at home?']) {
                    access['computer-at-home'] += 1;
                }
                
                if(response.fields['Web on cell phone?']) {
                    access['cell-phone'] += 1;
                }
                
                if(response.fields['Web on computer at work?']) {
                    access['computer-at-work'] += 1;
                }
                
                if(response.fields['Web on public computer?']) {
                    access['public-computer'] += 1;
                }
                
                if(response.fields["Web on friend's computer?"]) {
                    access['friend-computer'] += 1;
                }

                if(response.feature)
                {
                    geo_responses.push(response);
                }
            }
            
            for(var id in languages)
            {
                document.getElementById(id).innerText = languages[id];
            }
        
            for(var id in access)
            {
                document.getElementById(id).innerText = access[id];
            }
        
            var message = ('Found ' + stuff.tracts.length + ' tracts in ' + stuff.city.name + ' and <a target="_blank" href="' + spreadsheet_url + '">a spreadsheet with ' + geo_responses.length + ' geographic responses</a>.');
            update_status(message);
            jQuery( "body" ).trigger( "surveyMessage", [message] );
            _.defer(correlate_geographies,geo_responses, stuff.tracts, correlated_spreadsheet);
        }
        
        function correlated_spreadsheet(tracts)
        {
	        stuff.tracts = tracts;
	        
	        var regressions = [
	            ['Hispanic population', calculate_regression(tracts, 'B03002012', false /*'B01003001'*/)],
	            ['Black population', calculate_regression(tracts, 'B03002004', false /*'B01003001'*/)],
	            ['White population', calculate_regression(tracts, 'B03002003', false /*'B01003001'*/)],
	            ['Owner-occupied housing', calculate_regression(tracts, 'B25003002', false /*'B25003001'*/)],
	            ['Median household income', calculate_regression(tracts, 'B19013001', false)]
	            ];
	        
	        // Sort from most to least significant
	        regressions.sort(function(a, b) { return Math.abs(b[1]) - Math.abs(a[1]) });
	        
	        for(var i = 0; i < regressions.length; i++)
	        {
	            console.log(regressions[i][0], regressions[i][1]);
              update_overlay('survey-map', 'loading', 'Calculating reponse '+(i+1)+' of '+regressions.length+'...');
	            
	            var li = document.createElement('li');
	            li.innerText = regressions[i][0] + ': ' + regressions[i][1].toFixed(3);
	            document.getElementById('regressions').appendChild(li);
	        }

            update_status('Found ' + tracts.length + ' tracts in ' + stuff.city.name + ' and <a target="_blank" href="'+stuff.spreadsheet_url+'">a spreadsheet with ' + stuff.responses.length + ' responses</a>.');
            update_overlay('survey-map', 'loading', 'Update the map');
            render_survey_map();
        }
        
        function render_survey_map()
        {
            var geojson = {features: [], type: 'GeometryCollection'};
    
            for(var i = 0; i < stuff.tracts.length; i++)
            {
                var tract = stuff.tracts[i];
                var feature = tract.feature;
                feature.properties.data = tract.data;
                feature.properties.responses = tract.responses;
                geojson.features.push(feature);
            }
    
            var style_function = get_style_function(stuff.tracts, RESPONSES, GREENS);
    
            stuff.maps.survey.setData(geojson);
            stuff.maps.survey.setStyle(style_function);
            stuff.maps.survey.reloadStyle();
            stuff.maps.recommendation.setData(geojson);
            stuff.maps.recommendation.reloadStyle();
            remove_overlay('survey-map', 'loading');
        }

	</script>
</head>
<body>

    <p id="status">Hold on…</p>
    
    <div class="container">
        <div id="survey-map" ></div>
        <div id="recommendation-map"></div>
    </div>

    <h3>Regressions:</h3>
    <ol id="regressions">
    </ol>
    <p>(largest to smallest)</p>
    
    <h3>Response Languages:</h3>
    <ul>
        <li><span id="english">—</span> English</li>
        <li><span id="spanish">—</span> Spanish</li>
        <li><span id="chinese">—</span> Chinese</li>
        <li><span id="vietnamese">—</span> Vietnamese</li>
    </ul>
    
    <h3>Web Usage:</h3>
    <ul>
        <li><span id="computer-at-home">—</span> Computer at home</li>
        <li><span id="cell-phone">—</span> Cell phone</li>
        <li><span id="computer-at-work">—</span> Computer at work</li>
        <li><span id="public-computer">—</span> Public computer</li>
        <li><span id="friend-computer">—</span> Friend’s computer</li>
    </ul>

    <script>
        try_placename()
    </script>
    <script id="response-popup" type="text/template">
      <div id="response-content" class="clearfix">
      <div class="header">
        <h3>{tractName}</h3>
      </div>
      <div class="detail-row detail-housing-income clearfix">
        <div class="detail housing clearfix">
          <h4>
            <i class="fa fa-home"></i>
            <span cass="text">{rentalPercentage}<span class="percentage">%</span></span>
          </h4>
          <p class="label">rental percentage</p>
        </div>
        <div class="detail income clearfix">
          <h4>
            <i class="fa fa-usd"></i>
            <span cass="text">{income}</span>
          </h4>
          <p class="label">per capita income</p>
        </div>
      </div>
      <div class="detail-row detail-population-response clearfix">
        <div class="detail population clearfix">
          <h4>
            <i class="fa fa-male"></i>
            <span cass="text">{population}</span>
          </h4>
          <p class="label">population</p>
        </div>
        <div class="detail responses clearfix">
          <h4>
            <i class="fa fa-envelope"></i>
            <span cass="text">{round}{responses}</span>
          </h4>
          <p class="label">response{responsePlural}</p>
        </div>
      </div>
      <div class="detail-row last detail-population-segregation clearfix">
      <ul class="clearfix">
          <li>
            <h4>{white}<span>%</span></h4>
            <p class="label">White</p>
          </li>
          <li>
            <h4>{black}<span>%</span></h4>
            <p class="label">Black</p>
          </li>
          <li>
            <h4>{asian}<span>%</span></h4>
            <p class="label">Asian</p>
          </li>
          <li>
            <h4>{hispanic}<span>%</span></h4>
            <p class="label">Hispanic</p>
          </li>
      </ul>
      </div>
      </div>
    </script>
</body>
</html>
