<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Resident Web Use Results</title>
	<script src="https://code.jquery.com/jquery-1.11.2.min.js" charset="utf-8"></script>
	<script src="turf.min.js"></script>
	<script src="tabletop.js"></script>
	<script src="lib.js"></script>
	<script>
	
        function try_placename()
        {
            update_status('Loading city tracts…');
            load_city_tracts(get_query_variable('cityname'), loaded_tracts);
        }

	    function loaded_tracts(city_geoid, city_name, tracts)
	    {
            function onload(tracts)
            {
                loaded_data(city_geoid, city_name, tracts);
            }

            update_status('Found ' + tracts.length + ' tracts. Loading data…');
            load_tract_data(tracts, onload);
	    }
	    
	    function loaded_data(city_geoid, city_name, tracts)
	    {
            function onload(data)
            {
                loaded_spreadsheet(city_geoid, city_name, tracts, data);
            }

            function onerror(reason, ttop)
            {
                alert('Failed to load spreadsheet: ' + reason);
            }

            update_status('Loaded data for ' + tracts.length + ' tracts in ' + city_name + '. Loading spreadsheet…');
            load_spreadsheet(get_query_variable('gdoc'), 'Survey Results All', onload, onerror);
	    }

        function loaded_spreadsheet(city_geoid, city_name, tracts, data)
        {
            update_status('Found ' + tracts.length + ' tracts in ' + city_name + ' and a spreadsheet with ' + data.length + ' rows.');
            
            var areas = [];
            
            for(var i = 0; i < data.length; i++)
            {
                if(data[i][GEO_COLUMN])
                {
                    areas.push(data[i]);
                }
            }
            
            setTimeout(function() { correlate_geographies(areas, tracts) }, 10);
        }
        
        function correlate_geographies(areas, tracts)
        {
            console.log('Areas:', areas.length);
            console.log('One area:', areas[0][GEO_COLUMN]);
            
            console.log('Tracts:', tracts.length);
            console.log('One tract:', tracts[0]);
            
            for(var i = 0; i < areas.length; i++)
            {
                var area = areas[i][GEO_COLUMN],
                    // Overall population estimated to lie within this area.
                    population_estimate = 0,
                    // Tract-by-tract shares of overall population.
                    intersection_pops = {};
                
                for(var j = 0; j < tracts.length; j++)
                {
                    var tract = tracts[j],
                        intersection = turf.intersect(tract.feature, area);
                    
                    if(intersection)
                    {
                        var tract_share = turf.area(intersection) / turf.area(tract.feature),
                            intersection_pop = tract_share * tract.data['B01003001'].estimate;
                        
                        population_estimate += intersection_pop;
                        intersection_pops[tract.geoid] = intersection_pop;
                    
                        //console.log('Tract ' + tract.feature.properties.name + ' intersects area ' + area.properties.ZCTA5CE10 + ' by ' + Math.round(share * 100) + '%');
                    }
                }
            
                console.log('Area', area.properties.ZCTA5CE10, '-- est.', population_estimate, 'people');
                
                for(var j = 0; j < tracts.length; j++)
                {
                    var tract = tracts[j],
                        share = intersection_pops[tract.geoid] / population_estimate;
                    
                    if(share)
                    {
                        tract.responses += share;
                    }
                }
            }
            
            var total = 0;
            
            for(var i = 0; i < tracts.length; i++)
            {
                console.log('Tract', tracts[i].geoid, '-- est.', tracts[i].responses, 'responses');
                total += tracts[i].responses;
            }
            
            console.log('Total', total);
        }

	</script>
</head>
<body>

    <p id="status">Hold on…</p>

    <script>
        try_placename()
    </script>

</body>
</html>
