<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Resident Web Use Results</title>
	<script src="https://code.jquery.com/jquery-1.11.2.min.js" charset="utf-8"></script>
	<script src="turf.min.js"></script>
	<script src="regression.js"></script>
	<script src="tabletop.js"></script>
	<script src="lib.js"></script>
	<script>
	
        var stuff = {responses: null, tracts: null, city: {name: null, geoid: null}};
	
        function try_placename()
        {
            update_status('Loading city tracts…');
            load_city_tracts(get_query_variable('cityname'), loaded_tracts);
        }

	    function loaded_tracts(city_geoid, city_name, tracts)
	    {
	        stuff.city.geoid = city_geoid;
	        stuff.city.name = city_name;
	    
            update_status('Found ' + tracts.length + ' tracts. Loading data…');
            load_tract_data(tracts, loaded_tract_data);
	    }
	    
	    function loaded_tract_data(tracts)
	    {
	        stuff.tracts = tracts;
	    
            function onerror(reason, ttop)
            {
                alert('Failed to load spreadsheet: ' + reason);
            }

            update_status('Loaded data for ' + tracts.length + ' tracts in ' + stuff.city.name + '. Loading spreadsheet…');
            load_spreadsheet(get_query_variable('gdoc'), 'Survey Results All', loaded_spreadsheet, onerror);
	    }

        function loaded_spreadsheet(all_responses)
        {
            stuff.responses = all_responses;
            
            var geo_responses = [],
                languages = {
                "english": 0,
                "spanish": 0,
                "chinese": 0,
                "vietnamese": 0
                },
                access = {
                "computer-at-home": 0,
                "cell-phone": 0,
                "computer-at-work": 0,
                "public-computer": 0,
                "friend-computer": 0
                };
            
            for(var i = 0; i < all_responses.length; i++)
            {
                var response = all_responses[i],
                    language = response.fields['Language spoken at home'];
                
                if(language && language.toLocaleLowerCase() in languages) {
                    languages[language.toLocaleLowerCase()] += 1;
                }
                
                if(response.fields['Web on computer at home?']) {
                    access['computer-at-home'] += 1;
                }
                
                if(response.fields['Web on cell phone?']) {
                    access['cell-phone'] += 1;
                }
                
                if(response.fields['Web on computer at work?']) {
                    access['computer-at-work'] += 1;
                }
                
                if(response.fields['Web on public computer?']) {
                    access['public-computer'] += 1;
                }
                
                if(response.fields["Web on friend's computer?"]) {
                    access['friend-computer'] += 1;
                }

                if(response.feature)
                {
                    geo_responses.push(response);
                }
            }
            
            for(var id in languages)
            {
                document.getElementById(id).innerText = languages[id];
            }
        
            for(var id in access)
            {
                document.getElementById(id).innerText = access[id];
            }
        
            update_status('Found ' + stuff.tracts.length + ' tracts in ' + stuff.city.name + ' and a spreadsheet with ' + geo_responses.length + ' geographic responses.');
            correlate_geographies(geo_responses, stuff.tracts, correlated_spreadsheet);
        }
        
        function correlated_spreadsheet(tracts)
        {
	        stuff.tracts = tracts;
	        
	        var points = [],
	            total = 0;
	        
	        for(var i = 0; i < tracts.length; i++)
	        {
	            var t = tracts[i],
	                e = t.data['B03002012'].estimate,
	                r = t.responses;

	            points.push([e, r]);
	            total += r;
	        }
	        
	        var average = total / points.length;
	        
	        console.log(points.length, 'points', average, 'average');
	        
	        // Calculate linear regression using ordinary least squares
	        var result = regression('linear', points),
	            ss_residual = 0, ss_total = 0;
	        
	        for(var i = 0; i < points.length; i++)
	        {
	            var x = points[i][0], actual = points[i][1],
	                expected = result.points[i][1];
	            
	            ss_residual += Math.pow(actual - expected, 2);
	            ss_total += Math.pow(actual - average, 2);
	        }
	        
	        console.log(ss_total, 'total', ss_residual, 'residual');
	        
	        console.log('R^2:', 1 - ss_residual / ss_total);

            update_status('Found ' + tracts.length + ' tracts in ' + stuff.city.name + ' and a spreadsheet with ' + stuff.responses.length + ' responses.');
        }

	</script>
</head>
<body>

    <p id="status">Hold on…</p>
    
    <h3>Response Languages:</h3>
    <ul>
        <li><span id="english">—</span> English</li>
        <li><span id="spanish">—</span> Spanish</li>
        <li><span id="chinese">—</span> Chinese</li>
        <li><span id="vietnamese">—</span> Vietnamese</li>
    </ul>
    
    <h3>Web Usage:</h3>
    <ul>
        <li><span id="computer-at-home">—</span> Computer at home</li>
        <li><span id="cell-phone">—</span> Cell phone</li>
        <li><span id="computer-at-work">—</span> Computer at work</li>
        <li><span id="public-computer">—</span> Public computer</li>
        <li><span id="friend-computer">—</span> Friend’s computer</li>
    </ul>

    <script>
        try_placename()
    </script>

</body>
</html>
