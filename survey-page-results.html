<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Resident Web Use Results</title>
	<script src="https://code.jquery.com/jquery-1.11.2.min.js" charset="utf-8"></script>
	<script src="turf.min.js"></script>
	<script src="tabletop.js"></script>
	<script src="lib.js"></script>
	<script>
	
        var stuff = {responses: null, tracts: null, city: {name: null, geoid: null}};
	
        function try_placename()
        {
            update_status('Loading city tracts…');
            load_city_tracts(get_query_variable('cityname'), loaded_tracts);
        }

	    function loaded_tracts(city_geoid, city_name, tracts)
	    {
	        stuff.city.geoid = city_geoid;
	        stuff.city.name = city_name;
	    
            update_status('Found ' + tracts.length + ' tracts. Loading data…');
            load_tract_data(tracts, loaded_tract_data);
	    }
	    
	    function loaded_tract_data(tracts)
	    {
	        stuff.tracts = tracts;
	    
            function onerror(reason, ttop)
            {
                alert('Failed to load spreadsheet: ' + reason);
            }

            update_status('Loaded data for ' + tracts.length + ' tracts in ' + stuff.city.name + '. Loading spreadsheet…');
            load_spreadsheet(get_query_variable('gdoc'), 'Survey Results All', loaded_spreadsheet, onerror);
	    }

        function loaded_spreadsheet(all_responses)
        {
            stuff.responses = all_responses;
            
            var geo_responses = [];
            
            for(var i = 0; i < all_responses.length; i++)
            {
                if(all_responses[i].feature)
                {
                    geo_responses.push(all_responses[i]);
                }
            }
        
            update_status('Found ' + stuff.tracts.length + ' tracts in ' + stuff.city.name + ' and a spreadsheet with ' + geo_responses.length + ' geographic responses.');
            correlate_geographies(geo_responses, stuff.tracts, correlated_spreadsheet);
        }
        
        function correlated_spreadsheet(tracts)
        {
	        stuff.tracts = tracts;

            update_status('Found ' + tracts.length + ' tracts in ' + stuff.city.name + ' and a spreadsheet with ' + stuff.responses.length + ' responses.');
        }

	</script>
</head>
<body>

    <p id="status">Hold on…</p>

    <script>
        try_placename()
    </script>

</body>
</html>
